<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="/bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="/bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="/bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="/bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="/bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="/bower_components/paper-menu/paper-menu.html">
<link rel="import" href="/bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="/bower_components/iron-pages/iron-pages.html">
<link rel="import" href="/bower_components/app-storage/app-network-status-behavior.html">
<link rel="import" href="/bower_components/polymerfire/polymerfire.html">
<link rel="import" href="/bower_components/paper-fab/paper-fab.html">
<link rel="import" href="/bower_components/paper-toast/paper-toast.html">
<link rel="import" href="bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">

<link rel="import" href="/elements/qa-login.html">
<link rel="import" href="/elements/qa-editor.html">
<link rel="import" href="/elements/qa-quote.html">


<dom-module id="quotes-app">
    <template>
        <style>
            :host {
                --app-primary-color: red;
                --app-secondary-color: black;
                --app-toolbar-text-color: white;
                display: block;
                height: 100%;
            }

            app-header {
                color: #fff;
                background-color: var(--app-primary-color);
            }

            app-header paper-icon-button {
                --paper-icon-button-ink-color: white;
                color: var(--app-toolbar-text-color);
            }

            paper-item {
                display: block;
                padding: 10px;
            }

        </style>




        <iron-media-query query="min-width: 600px" query-matches="{{wideLayout}}"
                          on-query-matches-changed="closeMenu"></iron-media-query>


        <app-header-layout>
            <app-header fixed condenses effects="waterfall">

                <app-toolbar>
                    <paper-menu-button id="menu">
                        <paper-icon-button icon="menu" class="dropdown-trigger" vertical-align="bottom" horizontal-align="right"
                                           hidden$="{{wideLayout}}"></paper-icon-button>
                        <paper-menu class="dropdown-content" hidden$="{{wideLayout}}"
                                    selected="{{selected}}" attr-for-selected="name">
                            <paper-item name="home">home</paper-item>
                            <paper-item name="about">about</paper-item>
                        </paper-menu>
                    </paper-menu-button>
                    <div main-title>Awesome quotes</div>
                    <iron-icon icon="cloud" hidden$="[[!online]]"></iron-icon>
                    <iron-icon icon="cloud-off" hidden$="[[online]]"></iron-icon>
                    <paper-icon-button
                            icon="[[computeLockIcon(signedIn)]]"
                            disabled="[[!signedIn]]"
                            on-tap="signOut">
                    </paper-icon-button>
                </app-toolbar>
                <app-toolbar></app-toolbar>
                <app-toolbar class="tabs-bar" sticky hidden$="{{!wideLayout}}" paper-menu-toggle>
                    <!-- Nav on desktop: tabs -->
                    <paper-tabs selected="{{selected}}" attr-for-selected="name" bottom-item>
                        <paper-tab name="home">home</paper-tab>
                        <paper-tab name="about">about</paper-tab>
                    </paper-tabs>
                </app-toolbar>

            </app-header>

            <!--content-->

            <div style="height: 1000px">

                <iron-pages selected="{{selected}}" attr-for-selected="name">

                    <div name="home">
                        <qa-login signed-in="[[signedIn]]" on-sign-in="signIn" disabled="[[!online]]"></qa-login>

                        <paper-fab
                                icon="add"
                                on-tap="create"
                                disabled="[[!online]]"
                                aria-label="Add quote">
                        </paper-fab>

                        <template is="dom-repeat" items="{{quotes}}" as="item">
                            <qa-quote quote-element="[[item]]" on-edit="edit" on-delete="delete"></qa-quote>
                        </template>

                    </div>
                    <div name="about">[[selected]]</div>

                </iron-pages>
            </div>
        </app-header-layout>

        <qa-editor id="editor" wide-layout="[[wideLayout]]" on-close="editorClosed"
                   quote-element="{{editedQuote}}"></qa-editor>
        <paper-toast id="toast"></paper-toast>

        <!--firebase-->

        <firebase-auth
                id="auth"
                app-name="quotes"
                provider="google"
                signed-in="{{signedIn}}"
                on-error="onFirebaseError"
                user="{{user}}">
        </firebase-auth>

        <firebase-document
                id="document"
                app-name="quotes"
                path="[[editedQuoteRef]]"
                data="{{editedQuote}}">
        </firebase-document>


        <firebase-query
                id="query"
                app-name="quotes"
                path="/quotes/[[user.uid]]"
                data="{{liveQuotes}}">
        </firebase-query>

        <app-indexeddb-mirror
                session="[[user.uid]]"
                key="quotes"
                data="{{liveQuotes}}"
                persisted-data="{{quotes}}">
        </app-indexeddb-mirror>

    </template>

    <script>
        Polymer( {

            is: 'quotes-app',

            behaviors: [
                Polymer.AppNetworkStatusBehavior
            ],

            properties: {
                selected: {
                    type : String,
                    value: 'home',
                },
                editedQuoteRef: {
                    type: String,
                    notify: true
                }
            },

            closeMenu: function(){
                this.$.menu.close();
            },

            computeLockIcon: function(signedIn) {
                return signedIn ? 'lock-open' : 'lock';
            },

            lock: function() {
                this.fire('sign-out');
            },

            signIn: function(){
                this.$.auth.signInWithPopup();
            },

            signOut() {
                if (this.$.auth) {
                    this.$.auth.signOut();
                }
            },

            get firebaseCollectionRef(){
                return '/quotes/' + this.user.uid;
            },

            toFirebaseRef: function(quote){
                return this.firebaseCollectionRef + "/" + (quote.$key ? quote.$key : "");
            },

            create: function(){
                this.editedQuoteRef = null;
                this.$.editor.open();
            },

            onFirebaseError: function(event) {
                this.$.toast.text = event.detail.message;
                this.$.toast.show();
            },

            editorClosed: function(event){
                let doc = this.$.document;
                let q = this.editedQuote;
                console.log("editor closed", event.detail, q);

                if(doc.isNew && q.author && q.quote && q.quote.length > 3){
                    console.log( "saving", q );
                    doc.save( this.firebaseCollectionRef ).then( () => doc.reset() );
                }
            },


            edit: function(event){
                let qaQuote = Polymer.dom(event).localTarget;
                let quoteElement = qaQuote.quoteElement;
                this.editedQuoteRef = this.toFirebaseRef(quoteElement);
                this.$.editor.open({quote: quoteElement.quote, author: quoteElement.author});
            },

            delete: function(event){
                let qaQuote = Polymer.dom(event).localTarget;
                let quote = qaQuote.quoteElement;

                this.editedQuoteRef =  this.toFirebaseRef(quote);
                this.$.document.destroy();
            }

        } );
    </script>
</dom-module>
